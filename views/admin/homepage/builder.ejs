<%- include('../../partials/head.ejs') %>

<style>
    /* üé® MODERN DESIGN SYSTEM */
    :root {
        --primary: #6366f1; /* Indigo Modern */
        --primary-hover: #4f46e5;
        --dark-bg: #0f172a; /* Slate 900 */
        --light-bg: #f8fafc;
        --card-bg: #ffffff;
        --text-main: #1e293b;
        --text-muted: #64748b;
        --border-color: #e2e8f0;
        --radius: 16px;
        --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
    }

    body { background-color: var(--light-bg); font-family: 'Inter', system-ui, sans-serif; color: var(--text-main); }
    
    /* Layout */
    .admin-wrapper { display: flex; min-height: 100vh; }
    .admin-sidebar-container { width: 260px; position: fixed; height: 100vh; z-index: 1000; box-shadow: 1px 0 0 var(--border-color); background: #fff; }
    .admin-content { flex: 1; padding: 40px; margin-left: 260px; max-width: 1200px; margin-right: auto; }

    /* Header & Buttons */
    .builder-header h2 { font-size: 1.875rem; letter-spacing: -0.025em; color: var(--dark-bg); }
    
    .btn-pro {
        padding: 10px 24px;
        border-radius: 10px;
        font-weight: 600;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        font-size: 0.875rem;
    }
    .btn-primary-pro { background: var(--primary); color: #fff; border: none; box-shadow: 0 4px 14px 0 rgba(99, 102, 241, 0.39); }
    .btn-primary-pro:hover { background: var(--primary-hover); transform: translateY(-1px); box-shadow: 0 6px 20px rgba(99, 102, 241, 0.45); }
    
    .btn-outline-pro { background: #fff; border: 1px solid var(--border-color); color: var(--text-main); }
    .btn-outline-pro:hover { background: var(--light-bg); border-color: var(--text-muted); }

    /* Visual Layers - Section Item */
    .section-item {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: var(--radius);
        margin-bottom: 20px;
        padding: 0;
        display: flex;
        align-items: center;
        transition: all 0.3s ease;
        position: relative;
    }
    .section-item:hover {
        border-color: var(--primary);
        box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
    }

    .drag-handle {
        padding: 35px 25px;
        color: var(--text-muted);
        cursor: grab;
        background: #fcfdfe;
        border-radius: var(--radius) 0 0 var(--radius);
        border-right: 1px solid var(--border-color);
    }
    .drag-handle:active { cursor: grabbing; }

    .section-preview-icon {
        width: 48px; height: 48px;
        background: var(--light-bg);
        border-radius: 12px;
        display: flex; align-items: center; justify-content: center;
        margin-left: 20px; color: var(--primary); font-size: 1.25rem;
    }

    .section-body { flex: 1; padding: 0 25px; }
    .type-label { font-size: 10px; font-weight: 700; color: var(--primary); text-transform: uppercase; letter-spacing: 0.05em; }
    .section-title { font-weight: 700; font-size: 1.05rem; margin-top: 2px; color: var(--dark-bg); }

    /* Visibility Toggle */
    .status-badge {
        font-size: 11px; font-weight: 600; padding: 4px 12px; border-radius: 20px;
        display: inline-flex; align-items: center; gap: 5px;
    }
    .status-active { background: #ecfdf5; color: #059669; border: 1px solid #d1fae5; }
    .status-hidden { background: #fef2f2; color: #dc2626; border: 1px solid #fee2e2; }

    /* Sortable Ghost */
    .sortable-ghost { opacity: 0.2; background: var(--primary); border: 2px dashed var(--primary); }

    /* Modal Library Pro */
    .modal-content-pro { border-radius: 24px; border: none; overflow: hidden; }
    .lib-card {
        border: 1px solid var(--border-color); border-radius: 18px; padding: 30px;
        text-align: center; transition: all 0.3s; background: #fff; text-decoration: none !important;
    }
    .lib-card:hover { border-color: var(--primary); background: #f5f3ff; transform: translateY(-5px); }
    .lib-icon { font-size: 2.5rem; margin-bottom: 15px; display: block; }
</style>

<div class="admin-wrapper">
    <div class="admin-sidebar-container">
        <%- include('../partials/sidebar.ejs') %>
    </div>

    <div class="admin-content">
        <div class="builder-header d-flex justify-content-between align-items-center mb-5">
            <div>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb mb-2">
                        <li class="breadcrumb-item small"><a href="/admin" class="text-muted">B·∫£ng tin</a></li>
                        <li class="breadcrumb-item small active fw-bold">Giao di·ªán</li>
                    </ol>
                </nav>
                <h2 class="fw-bold m-0">UX Builder <span class="text-muted ms-2 fs-6 fw-normal">/ Trang ch·ªß</span></h2>
            </div>
            <div class="d-flex gap-3">
                <a href="/" target="_blank" class="btn-pro btn-outline-pro">
                    <i class="fas fa-external-link-alt"></i> Preview Web
                </a>
                <button class="btn-pro btn-primary-pro" data-bs-toggle="modal" data-bs-target="#addSectionModal">
                    <i class="fas fa-plus"></i> Th√™m kh·ªëi n·ªôi dung
                </button>
            </div>
        </div>

        <div id="sortable-canvas">
            <% if (sections && sections.length > 0) { %>
                <% sections.forEach((section) => { %>
                    <div class="section-item" data-id="<%= section._id %>">
                        <div class="drag-handle"><i class="fas fa-grip-vertical"></i></div>
                        
                        <div class="section-preview-icon">
                            <% if(section.type === 'hero') { %><i class="fas fa-window-maximize"></i><% } %>
                            <% if(section.type === 'product-grid') { %><i class="fas fa-th-large"></i><% } %>
                            <% if(section.type === 'features') { %><i class="fas fa-shield-alt"></i><% } %>
                            <% if(section.type === 'promo') { %><i class="fas fa-tags"></i><% } %>
                        </div>

                        <div class="section-body">
                            <span class="type-label"><%= section.type %></span>
                            <div class="section-title"><%= section.data.title || 'Kh·ªëi n·ªôi dung tr·ªëng' %></div>
                            <div class="mt-1">
                                <% if(section.isActive) { %>
                                    <span class="status-badge status-active"><i class="fas fa-circle fs-small" style="font-size: 6px;"></i> ƒêang hi·ªÉn th·ªã</span>
                                <% } else { %>
                                    <span class="status-badge status-hidden">ƒêang ·∫©n</span>
                                <% } %>
                            </div>
                        </div>

                        <div class="pe-4 d-flex gap-3">
                            <a href="/admin/homepage/edit-section/<%= section._id %>" class="btn-pro btn-outline-pro py-2">
                                <i class="fas fa-sliders-h text-primary"></i> C·∫•u h√¨nh
                            </a>
                            <form action="/admin/homepage/delete-section" method="POST" onsubmit="return confirm('G·ª° b·ªè kh·ªëi n√†y kh·ªèi trang ch·ªß?')">
                                <input type="hidden" name="sectionId" value="<%= section._id %>">
                                <button class="btn btn-sm btn-link text-danger p-0 border-0"><i class="fas fa-trash-alt"></i></button>
                            </form>
                        </div>
                    </div>
                <% }) %>
            <% } else { %>
                <div class="text-center py-5 bg-white rounded-4 border-2 border-dashed">
                    <div class="mb-3 text-muted opacity-50"><i class="fas fa-layer-group fa-4x"></i></div>
                    <h5 class="fw-bold">Giao di·ªán ch∆∞a c√≥ n·ªôi dung</h5>
                    <button class="btn-pro btn-primary-pro mt-3" data-bs-toggle="modal" data-bs-target="#addSectionModal">X√¢y d·ª±ng ngay</button>
                </div>
            <% } %>
        </div>
    </div>
</div>

<div class="modal fade" id="addSectionModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content modal-content-pro shadow-lg">
            <div class="modal-header border-0 p-4 pb-0">
                <h4 class="fw-bold m-0 text-dark">Th∆∞ vi·ªán kh·ªëi Pro</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <div class="row g-4 text-center">
                    <div class="col-md-4">
                        <a href="/admin/homepage/add-section/hero" class="lib-card d-block h-100">
                            <i class="fas fa-image lib-icon text-primary"></i>
                            <h6 class="fw-bold text-dark">Main Visual Hero</h6>
                            <p class="text-muted small m-0">Banner k√≠ch th∆∞·ªõc l·ªõn k√®m n√∫t k√™u g·ªçi h√†nh ƒë·ªông.</p>
                        </a>
                    </div>
                    <div class="col-md-4">
                        <a href="/admin/homepage/add-section/product-grid" class="lib-card d-block h-100">
                            <i class="fas fa-box-open lib-icon text-success"></i>
                            <h6 class="fw-bold text-dark">Product Showcase</h6>
                            <p class="text-muted small m-0">L∆∞·ªõi s·∫£n ph·∫©m t·ª± ƒë·ªông l·∫•y theo danh m·ª•c.</p>
                        </a>
                    </div>
                    <div class="col-md-4">
                        <a href="/admin/homepage/add-section/features" class="lib-card d-block h-100">
                            <i class="fas fa-star lib-icon text-warning"></i>
                            <h6 class="fw-bold text-dark">Trust Badges</h6>
                            <p class="text-muted small m-0">Gi·ªõi thi·ªáu d·ªãch v·ª•, v·∫≠n chuy·ªÉn v√† cam k·∫øt.</p>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="toast-container" style="position: fixed; bottom: 30px; right: 30px; z-index: 9999;"></div>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
    function showToast(message, isError = false) {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = 'bg-dark text-white px-4 py-3 rounded-pill shadow-lg fw-bold d-flex align-items-center gap-3 animate__animated animate__fadeInUp';
        if(isError) toast.classList.add('border', 'border-danger');
        toast.innerHTML = `<i class="fas ${isError ? 'fa-exclamation-circle text-danger' : 'fa-check-circle text-success'}"></i> ${message}`;
        container.appendChild(toast);
        setTimeout(() => {
            toast.classList.replace('animate__fadeInUp', 'animate__fadeOutDown');
            setTimeout(() => toast.remove(), 500);
        }, 3000);
    }

    const canvas = document.getElementById('sortable-canvas');
    if (canvas) {
        Sortable.create(canvas, {
            handle: '.drag-handle',
            animation: 300,
            ghostClass: 'sortable-ghost',
            onEnd: function() {
                // 1. L·∫•y t·∫•t c·∫£ c√°c ph·∫ßn t·ª≠ c√≥ class .section-item b√™n trong canvas
                const items = Array.from(canvas.querySelectorAll('.section-item'));
                
                // 2. Tr√≠ch xu·∫•t m·∫£ng ID t·ª´ thu·ªôc t√≠nh data-id ƒë√£ c√≥ s·∫µn tr√™n HTML
                const sectionIds = items.map(item => item.getAttribute('data-id'));
                
                console.log("Danh s√°ch ID m·ªõi:", sectionIds);

                // 3. G·ª≠i AJAX l√™n server
                fetch('/admin/homepage/update-order', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ order: sectionIds })
                })
                .then(res => res.json())
                .then(data => {
                    if(data.success) {
                        showToast('ƒê√£ c·∫≠p nh·∫≠t th·ª© t·ª± th√†nh c√¥ng!');
                    } else {
                        showToast('L·ªói: ' + data.message, true);
                    }
                })
                .catch(err => showToast('L·ªói k·∫øt n·ªëi m√°y ch·ªß', true));
            } // <--- Th√™m d·∫•u ƒë√≥ng h√†m onEnd
        }); // <--- Th√™m d·∫•u ƒë√≥ng Sortable.create
    } // <--- Th√™m d·∫•u ƒë√≥ng if (canvas)
</script>