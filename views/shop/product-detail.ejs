<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= product.name %> | Fashion Shop</title>
    
    <meta name="description" content="<%= product.description ? product.description.substring(0, 160).replace(/<[^>]*>?/gm, '') : product.name %>">
    <link rel="canonical" href="https://webbanhang-es90.onrender.com/products/<%= product.slug %>">
    
    <meta property="og:title" content="<%= product.name %>">
    <meta property="og:description" content="<%= product.description ? product.description.substring(0, 100).replace(/<[^>]*>?/gm, '') : '' %>">
    <meta property="og:image" content="<%= product.thumbnail %>">
    <meta property="og:url" content="https://webbanhang-es90.onrender.com/products/<%= product.slug %>">
    <meta property="og:type" content="product">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { background-color: #f8f9fa; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        
        /* Ảnh sản phẩm */
        .product-gallery { position: sticky; top: 20px; }
        .main-img-container {
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #eee;
            background: #fff;
            position: relative;
            margin-bottom: 10px;
        }
        .main-img { width: 100%; height: auto; aspect-ratio: 1/1; object-fit: contain; transition: transform 0.3s ease; }
        .main-img:hover { transform: scale(1.05); }
        
        .thumb-list { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 5px; }
        .thumb-img { 
            width: 70px; height: 70px; object-fit: cover; 
            border: 1px solid #ddd; border-radius: 4px; cursor: pointer; 
            opacity: 0.7; transition: all 0.2s;
        }
        .thumb-img:hover, .thumb-img.active { opacity: 1; border: 2px solid #000; }

        /* Thông tin sản phẩm */
        .product-title { font-size: 1.75rem; font-weight: 700; color: #333; }
        .product-price { font-size: 1.5rem; color: #dc3545; font-weight: bold; }
        .old-price { font-size: 1.1rem; color: #999; text-decoration: line-through; margin-left: 10px; }
        
        .quantity-input-group { width: 140px; }
        .quantity-input-group input { text-align: center; border-left: 0; border-right: 0; }
        .quantity-btn { border: 1px solid #ced4da; background: #fff; }
        .quantity-btn:hover { background: #f8f9fa; }

        /* Tab Mô tả */
        .nav-tabs .nav-link { color: #555; font-weight: 600; }
        .nav-tabs .nav-link.active { color: #000; border-bottom: 3px solid #000; }
        .description-content img { max-width: 100%; height: auto; }

        /* Card liên quan */
        .card-product { transition: all 0.3s; border: none; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .card-product:hover { transform: translateY(-5px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .card-product img { height: 250px; object-fit: cover; }
    </style>

    <script type="application/ld+json">
    {
      "@context": "https://schema.org/",
      "@type": "Product",
      "name": "<%= product.name %>",
      "image": ["<%= product.thumbnail %>"],
      "description": "<%= product.description ? product.description.substring(0, 160).replace(/<[^>]*>?/gm, '') : '' %>",
      "sku": "<%= product._id %>",
      "offers": {
        "@type": "Offer",
        "url": "https://webbanhang-es90.onrender.com/products/<%= product.slug %>",
        "priceCurrency": "VND",
        "price": "<%= product.salePrice > 0 ? product.salePrice : product.basePrice %>",
        "availability": "https://schema.org/InStock"
      }
    }
    </script>
</head>
<body>

    

    <div class="bg-light py-2 border-bottom mb-4">
        <div class="container">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb m-0 small">
                    <li class="breadcrumb-item"><a href="/" class="text-decoration-none text-muted">Trang chủ</a></li>
                    <li class="breadcrumb-item"><a href="/products" class="text-decoration-none text-muted">Sản phẩm</a></li>
                    <li class="breadcrumb-item active text-dark" aria-current="page"><%= product.name %></li>
                </ol>
            </nav>
        </div>
    </div>

    <div class="container mb-5">
        <div class="row">
            <div class="col-md-6 mb-4">
                <div class="product-gallery">
                    <div class="main-img-container">
                        <img id="mainImage" src="<%= product.thumbnail %>" class="main-img" alt="<%= product.name %>">
                        <% if (product.salePrice > 0) { %>
                            <span class="position-absolute top-0 start-0 bg-danger text-white px-2 py-1 m-2 rounded fw-bold small">
                                -<%= Math.round(((product.basePrice - product.salePrice) / product.basePrice) * 100) %>%
                            </span>
                        <% } %>
                    </div>
                    
                    <% if (product.images && product.images.length > 0) { %>
                        <div class="thumb-list">
                            <img src="<%= product.thumbnail %>" class="thumb-img active" onclick="changeImage(this, '<%= product.thumbnail %>')">
                            
                            <% product.images.forEach(img => { %>
                                <img src="<%= img %>" class="thumb-img" onclick="changeImage(this, '<%= img %>')">
                            <% }) %>
                        </div>
                    <% } %>
                </div>
            </div>

            <div class="col-md-6">
                <h1 class="product-title mb-2"><%= product.name %></h1>
                
                <div class="d-flex align-items-center mb-3">
                    <div class="text-warning small me-2">
                        <i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star-half-alt"></i>
                    </div>
                    <span class="text-muted small border-start ps-2">Đã bán: 120+</span>
                </div>

                <div class="mb-3">
                    <% if (product.salePrice > 0) { %>
                        <span class="product-price"><%= product.salePrice.toLocaleString('vi-VN') %>₫</span>
                        <span class="old-price"><%= product.basePrice.toLocaleString('vi-VN') %>₫</span>
                    <% } else { %>
                        <span class="product-price"><%= product.basePrice.toLocaleString('vi-VN') %>₫</span>
                    <% } %>
                </div>

                <div class="alert alert-light border mb-4 py-2">
                    <ul class="list-unstyled m-0 small">
                        <li class="mb-1"><i class="fas fa-check-circle text-success me-2"></i>Hàng chính hãng 100%</li>
                        <li class="mb-1"><i class="fas fa-shipping-fast text-primary me-2"></i>Miễn phí vận chuyển đơn từ 500k</li>
                        <li><i class="fas fa-undo text-danger me-2"></i>Đổi trả trong vòng 7 ngày</li>
                    </ul>
                </div>

                <form action="/cart/add" method="POST">
                    <input type="hidden" name="productId" value="<%= product._id %>">

                    <% if (product.variants && product.variants.length > 0) { %>
                        <div class="mb-3">
                            <label class="fw-bold mb-2 small text-uppercase">Phân loại:</label>
                            <select name="variant" class="form-select">
                                <% product.variants.forEach(v => { %>
                                    <option value="<%= v.color %>-<%= v.size %>">
                                        Màu <%= v.color %> - Size <%= v.size %> (Còn <%= v.quantity %>)
                                    </option>
                                <% }) %>
                            </select>
                        </div>
                    <% } %>

                    <div class="mb-4 d-flex align-items-center">
                        <label class="fw-bold me-3 small text-uppercase">Số lượng:</label>
                        <div class="input-group quantity-input-group">
                            <button type="button" class="btn quantity-btn" onclick="updateQty(-1)"><i class="fas fa-minus small"></i></button>
                            <input type="number" id="qtyInput" name="quantity" value="1" min="1" max="50" class="form-control">
                            <button type="button" class="btn quantity-btn" onclick="updateQty(1)"><i class="fas fa-plus small"></i></button>
                        </div>
                    </div>

                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-dark flex-grow-1 py-3 fw-bold text-uppercase">
                            <i class="fas fa-shopping-bag me-2"></i> Thêm vào giỏ
                        </button>
                        <button type="button" class="btn btn-outline-danger py-3 px-3">
                            <i class="far fa-heart"></i>
                        </button>
                    </div>
                </form>

                <div class="mt-4 pt-3 border-top d-flex align-items-center small text-muted">
                    <span class="me-2">Chia sẻ:</span>
                    <a href="#" class="text-decoration-none text-muted me-3"><i class="fab fa-facebook fa-lg"></i></a>
                    <a href="#" class="text-decoration-none text-muted me-3"><i class="fab fa-facebook-messenger fa-lg"></i></a>
                    <a href="#" class="text-decoration-none text-muted"><i class="fab fa-twitter fa-lg"></i></a>
                </div>
            </div>
        </div>

        <div class="row mt-5">
            <div class="col-12">
                <ul class="nav nav-tabs mb-4" id="myTab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="desc-tab" data-bs-toggle="tab" data-bs-target="#desc" type="button">Mô tả sản phẩm</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="policy-tab" data-bs-toggle="tab" data-bs-target="#policy" type="button">Chính sách giao hàng</button>
                    </li>
                </ul>
                <div class="tab-content bg-white p-4 border rounded shadow-sm" id="myTabContent">
                    <div class="tab-pane fade show active description-content" id="desc" role="tabpanel">
                        <%- product.description ? product.description : '<p class="text-muted text-center">Đang cập nhật...</p>' %>
                    </div>
                    <div class="tab-pane fade" id="policy" role="tabpanel">
                        <p><strong>1. Thời gian giao hàng:</strong><br>Nội thành: 1-2 ngày. Ngoại thành: 3-5 ngày.</p>
                        <p><strong>2. Phí vận chuyển:</strong><br>Đồng giá 30k toàn quốc. Freeship đơn từ 500k.</p>
                        <p><strong>3. Kiểm hàng:</strong><br>Được kiểm tra hàng trước khi thanh toán.</p>
                    </div>
                </div>
            </div>
        </div>

        <% if (typeof relatedProducts !== 'undefined' && relatedProducts.length > 0) { %>
            <div class="mt-5">
                <h3 class="fw-bold mb-4 text-center">Có thể bạn sẽ thích</h3>
                <div class="row row-cols-1 row-cols-md-4 g-4">
                    <% relatedProducts.forEach(relProd => { %>
                        <div class="col">
                            <div class="card h-100 card-product">
                                <a href="/products/<%= relProd.slug %>">
                                    <img src="<%= relProd.thumbnail %>" class="card-img-top" alt="<%= relProd.name %>">
                                </a>
                                <div class="card-body text-center">
                                    <h6 class="card-title text-truncate">
                                        <a href="/products/<%= relProd.slug %>" class="text-decoration-none text-dark"><%= relProd.name %></a>
                                    </h6>
                                    <div class="fw-bold text-danger"><%= relProd.basePrice.toLocaleString('vi-VN') %>₫</div>
                                </div>
                            </div>
                        </div>
                    <% }) %>
                </div>
            </div>
        <% } %>
    </div>

    <%- include('../partials/footer.ejs') %>

    <script>
        // Đổi ảnh khi click vào thumbnail
        function changeImage(element, src) {
            document.getElementById('mainImage').src = src;
            
            // Xử lý active class
            document.querySelectorAll('.thumb-img').forEach(img => img.classList.remove('active'));
            element.classList.add('active');
        }

        // Tăng giảm số lượng
        function updateQty(change) {
            const input = document.getElementById('qtyInput');
            let newVal = parseInt(input.value) + change;
            if (newVal < 1) newVal = 1;
            if (newVal > 50) newVal = 50;
            input.value = newVal;
        }
    </script>
</body>
</html>