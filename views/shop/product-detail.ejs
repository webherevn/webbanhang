<%- include('../partials/head.ejs') %>

<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= product.name %> | Fashion Shop</title>
    
    <meta name="description" content="<%= product.description ? product.description.substring(0, 160).replace(/<[^>]*>?/gm, '') : product.name %>">
    <link rel="canonical" href="https://webbanhang-es90.onrender.com/products/<%= product.slug %>">
    
    <meta property="og:title" content="<%= product.name %>">
    <meta property="og:description" content="<%= product.description ? product.description.substring(0, 100).replace(/<[^>]*>?/gm, '') : '' %>">
    <meta property="og:image" content="<%= product.thumbnail %>">
    <meta property="og:url" content="https://webbanhang-es90.onrender.com/products/<%= product.slug %>">
    <meta property="og:type" content="product">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { background-color: #f8f9fa; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        
        /* Ảnh sản phẩm */
        .product-gallery { position: sticky; top: 20px; }
        .main-img-container {
            border-radius: 8px; overflow: hidden; border: 1px solid #eee; background: #fff;
            position: relative; margin-bottom: 10px;
        }
        .main-img { width: 100%; height: auto; aspect-ratio: 1/1; object-fit: contain; transition: transform 0.3s ease; }
        .main-img:hover { transform: scale(1.05); }
        
        .thumb-list { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 5px; }
        .thumb-img { 
            width: 70px; height: 70px; object-fit: cover; 
            border: 1px solid #ddd; border-radius: 4px; cursor: pointer; 
            opacity: 0.7; transition: all 0.2s;
        }
        .thumb-img:hover, .thumb-img.active { opacity: 1; border: 2px solid #000; }

        /* Thông tin sản phẩm */
        .product-title { font-size: 1.75rem; font-weight: 700; color: #333; }
        
        /* CSS Giá Tiền Động */
        .product-price { font-size: 1.8rem; color: #dc3545; font-weight: bold; background: #fafafa; padding: 10px 15px; display: inline-block; border-radius: 4px; }
        .old-price { font-size: 1.1rem; color: #999; text-decoration: line-through; margin-left: 10px; }
        
        /* CSS Nút Biến Thể (Shopee Style) */
        .variant-label { width: 100px; font-weight: 600; color: #555; font-size: 14px; }
        .variant-option {
            min-width: 80px; text-align: center; border: 1px solid #e0e0e0; 
            background: #fff; color: #333; padding: 6px 15px; margin-right: 8px; margin-bottom: 8px;
            cursor: pointer; border-radius: 2px; font-size: 14px; transition: all 0.2s; position: relative;
        }
        .variant-option:hover { border-color: #dc3545; color: #dc3545; }
        .variant-option.active { 
            border-color: #dc3545; color: #dc3545; background-color: #fff5f5; 
        }
        .variant-option.active::after {
            content: ''; position: absolute; bottom: 0; right: 0;
            width: 0; height: 0; border-style: solid;
            border-width: 0 0 12px 12px; border-color: transparent transparent #dc3545 transparent;
        }

        .quantity-input-group { width: 130px; }
        .quantity-input-group input { text-align: center; border-left: 0; border-right: 0; }
        .quantity-btn { border: 1px solid #ced4da; background: #fff; }
        .quantity-btn:hover { background: #f8f9fa; }

        /* Tab & Card */
        .nav-tabs .nav-link { color: #555; font-weight: 600; }
        .nav-tabs .nav-link.active { color: #000; border-bottom: 3px solid #000; }
        .description-content img { max-width: 100%; height: auto; }
        .card-product { transition: all 0.3s; border: none; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .card-product:hover { transform: translateY(-5px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .card-product img { height: 250px; object-fit: cover; }
    </style>

    <script type="application/ld+json">
    {
      "@context": "https://schema.org/",
      "@type": "Product",
      "name": "<%= product.name %>",
      "image": ["<%= product.thumbnail %>"],
      "description": "<%= product.description ? product.description.substring(0, 160).replace(/<[^>]*>?/gm, '') : '' %>",
      "sku": "<%= product._id %>",
      "offers": {
        "@type": "Offer",
        "url": "https://webbanhang-es90.onrender.com/products/<%= product.slug %>",
        "priceCurrency": "VND",
        "price": "<%= product.salePrice > 0 ? product.salePrice : product.basePrice %>",
        "availability": "https://schema.org/InStock"
      }
    }
    </script>
</head>
<body>

    <%- include('../partials/shop-header.ejs') %>

    <div class="bg-light py-2 border-bottom mb-4">
        <div class="container">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb m-0 small">
                    <li class="breadcrumb-item"><a href="/" class="text-decoration-none text-muted">Trang chủ</a></li>
                    <li class="breadcrumb-item"><a href="/products" class="text-decoration-none text-muted">Sản phẩm</a></li>
                    <li class="breadcrumb-item active text-dark" aria-current="page"><%= product.name %></li>
                </ol>
            </nav>
        </div>
    </div>

    <div class="container mb-5">
        <div class="row">
            <div class="col-md-6 mb-4">
                <div class="product-gallery">
                    <div class="main-img-container">
                        <img id="mainImage" src="<%= product.thumbnail %>" class="main-img" alt="<%= product.name %>">
                        <% if (product.salePrice > 0 && !product.hasVariants) { %>
                            <span class="position-absolute top-0 start-0 bg-danger text-white px-2 py-1 m-2 rounded fw-bold small">
                                -<%= Math.round(((product.basePrice - product.salePrice) / product.basePrice) * 100) %>%
                            </span>
                        <% } %>
                    </div>
                    
                    <% 
                        // Logic hiển thị ảnh: Hỗ trợ cả tên biến cũ 'images' và mới 'gallery'
                        let album = [];
                        if (product.gallery && product.gallery.length > 0) album = product.gallery;
                        else if (product.images && product.images.length > 0) album = product.images;
                    %>

                    <% if (album.length > 0) { %>
                        <div class="thumb-list">
                            <img src="<%= product.thumbnail %>" class="thumb-img active" onclick="changeImage(this, '<%= product.thumbnail %>')">
                            <% album.forEach(img => { %>
                                <% if (img !== product.thumbnail) { %>
                                    <img src="<%= img %>" class="thumb-img" onclick="changeImage(this, '<%= img %>')">
                                <% } %>
                            <% }) %>
                        </div>
                    <% } %>
                </div>
            </div>

            <div class="col-md-6">
                <h1 class="product-title mb-2"><%= product.name %></h1>
                
                <div class="d-flex align-items-center mb-3">
                    <div class="text-warning small me-2">
                        <i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star-half-alt"></i>
                    </div>
                    <span class="text-muted small border-start ps-2">Đã bán: 120+</span>
                </div>

                <div class="mb-4">
                    <div class="product-price" id="displayPrice">
                        <% if (product.hasVariants && product.variants.length > 0) { %>
                            <% 
                                const prices = product.variants.map(v => v.price);
                                const min = Math.min(...prices).toLocaleString('vi-VN');
                                const max = Math.max(...prices).toLocaleString('vi-VN');
                            %>
                            <%= min === max ? min + '₫' : min + '₫ - ' + max + '₫' %>
                        <% } else { %>
                            <%= product.salePrice > 0 ? product.salePrice.toLocaleString('vi-VN') : product.basePrice.toLocaleString('vi-VN') %>₫
                            <% if(product.salePrice > 0) { %>
                                <span class="old-price" style="font-size: 1rem;"><%= product.basePrice.toLocaleString('vi-VN') %>₫</span>
                            <% } %>
                        <% } %>
                    </div>
                </div>

                <div class="alert alert-light border mb-4 py-2">
                    <ul class="list-unstyled m-0 small">
                        <li class="mb-1"><i class="fas fa-check-circle text-success me-2"></i>Hàng chính hãng 100%</li>
                        <li class="mb-1"><i class="fas fa-shipping-fast text-primary me-2"></i>Miễn phí vận chuyển đơn từ 500k</li>
                        <li><i class="fas fa-undo text-danger me-2"></i>Đổi trả trong vòng 7 ngày</li>
                    </ul>
                </div>

                <form action="/cart/add" method="POST" id="addToCartForm">
                    <input type="hidden" name="productId" value="<%= product._id %>">

                    <% if (product.hasVariants && product.variants.length > 0) { %>
                        <input type="hidden" name="selectedColor" id="selectedColor" required>
                        <input type="hidden" name="selectedSize" id="selectedSize" required>
                        
                        <% 
                            const uniqueColors = [...new Set(product.variants.map(v => v.color))];
                            const uniqueSizes = [...new Set(product.variants.map(v => v.size))];
                        %>

                        <div class="mb-3 d-flex align-items-baseline">
                            <span class="variant-label">Màu sắc</span>
                            <div class="d-flex flex-wrap">
                                <% uniqueColors.forEach(color => { %>
                                    <div class="variant-option btn-color" 
                                         data-value="<%= color %>"
                                         onclick="selectOption(this, 'color')">
                                        <%= color %>
                                    </div>
                                <% }) %>
                            </div>
                        </div>

                        <div class="mb-3 d-flex align-items-baseline">
                            <span class="variant-label">Kích thước</span>
                            <div class="d-flex flex-wrap">
                                <% uniqueSizes.forEach(size => { %>
                                    <div class="variant-option btn-size" 
                                         data-value="<%= size %>"
                                         onclick="selectOption(this, 'size')">
                                        <%= size %>
                                    </div>
                                <% }) %>
                            </div>
                        </div>
                        
                        <div class="mb-3 d-flex align-items-center">
                            <span class="variant-label"></span>
                            <small class="text-muted" id="stock-status">Vui lòng chọn phân loại</small>
                        </div>
                    <% } %>

                    <div class="mb-4 d-flex align-items-center">
                        <span class="variant-label text-uppercase small" style="color: #333;">Số lượng</span>
                        <div class="input-group quantity-input-group">
                            <button type="button" class="btn quantity-btn" onclick="updateQty(-1)"><i class="fas fa-minus small"></i></button>
                            <input type="number" id="qtyInput" name="quantity" value="1" min="1" max="50" class="form-control">
                            <button type="button" class="btn quantity-btn" onclick="updateQty(1)"><i class="fas fa-plus small"></i></button>
                        </div>
                    </div>

                    <div class="d-flex gap-2">
                        <button type="submit" id="btn-add-cart" class="btn btn-dark flex-grow-1 py-3 fw-bold text-uppercase" 
                                <%= product.hasVariants ? 'disabled' : '' %>>
                            <i class="fas fa-shopping-bag me-2"></i> 
                            <span id="btn-text"><%= product.hasVariants ? 'Chọn phân loại hàng' : 'Thêm vào giỏ' %></span>
                        </button>
                        <button type="button" class="btn btn-outline-danger py-3 px-3">
                            <i class="far fa-heart"></i>
                        </button>
                    </div>
                </form>

                <div class="mt-4 pt-3 border-top d-flex align-items-center small text-muted">
                    <span class="me-2">Chia sẻ:</span>
                    <a href="#" class="text-decoration-none text-muted me-3"><i class="fab fa-facebook fa-lg"></i></a>
                    <a href="#" class="text-decoration-none text-muted me-3"><i class="fab fa-facebook-messenger fa-lg"></i></a>
                    <a href="#" class="text-decoration-none text-muted"><i class="fab fa-twitter fa-lg"></i></a>
                </div>
            </div>
        </div>

        <div class="row mt-5">
            <div class="col-12">
                <ul class="nav nav-tabs mb-4" id="myTab" role="tablist">
                    <li class="nav-item"><button class="nav-link active" id="desc-tab" data-bs-toggle="tab" data-bs-target="#desc">Mô tả sản phẩm</button></li>
                    <li class="nav-item"><button class="nav-link" id="policy-tab" data-bs-toggle="tab" data-bs-target="#policy">Chính sách giao hàng</button></li>
                </ul>
                <div class="tab-content bg-white p-4 border rounded shadow-sm">
                    <div class="tab-pane fade show active description-content" id="desc">
                        <%- product.description ? product.description : '<p class="text-muted text-center">Đang cập nhật...</p>' %>
                    </div>
                    
                    <div class="tab-pane fade" id="policy">
                        <% if (product.shippingPolicy && product.shippingPolicy.trim() !== '') { %>
                            <div class="description-content">
                                <%- product.shippingPolicy %>
                            </div>
                        <% } else { %>
                            <p><strong>1. Thời gian giao hàng:</strong><br>Nội thành: 1-2 ngày. Ngoại thành: 3-5 ngày.</p>
                            <p><strong>2. Phí vận chuyển:</strong><br>Đồng giá 30k toàn quốc. Freeship đơn từ 500k.</p>
                        <% } %>
                    </div>
                    </div>
            </div>
        </div>

        <% if (typeof relatedProducts !== 'undefined' && relatedProducts.length > 0) { %>
            <div class="mt-5">
                <h3 class="fw-bold mb-4 text-center">Có thể bạn sẽ thích</h3>
                <div class="row row-cols-1 row-cols-md-4 g-4">
                    <% relatedProducts.forEach(relProd => { %>
                        <div class="col">
                            <div class="card h-100 card-product">
                                <a href="/products/<%= relProd.slug %>"><img src="<%= relProd.thumbnail %>" class="card-img-top"></a>
                                <div class="card-body text-center">
                                    <h6 class="card-title text-truncate"><a href="/products/<%= relProd.slug %>" class="text-decoration-none text-dark"><%= relProd.name %></a></h6>
                                    <div class="fw-bold text-danger"><%= relProd.basePrice.toLocaleString('vi-VN') %>₫</div>
                                </div>
                            </div>
                        </div>
                    <% }) %>
                </div>
            </div>
        <% } %>
    </div>

    <%- include('../partials/footer.ejs') %>

    <script>
        // 1. Đổi ảnh Thumbnail
        function changeImage(element, src) {
            document.getElementById('mainImage').src = src;
            document.querySelectorAll('.thumb-img').forEach(img => img.classList.remove('active'));
            element.classList.add('active');
        }

        // 2. Tăng giảm số lượng
        function updateQty(change) {
            const input = document.getElementById('qtyInput');
            let newVal = parseInt(input.value) + change;
            if (newVal < 1) newVal = 1;
            if (newVal > 50) newVal = 50;
            input.value = newVal;
        }

        // 3. XỬ LÝ BIẾN THỂ & GIÁ ĐỘNG
        const variantsData = <%- JSON.stringify(product.variants || []) %>;
        const hasVariants = <%= product.hasVariants %>;

        function selectOption(element, type) {
            if (type === 'color') document.querySelectorAll('.btn-color').forEach(el => el.classList.remove('active'));
            if (type === 'size') document.querySelectorAll('.btn-size').forEach(el => el.classList.remove('active'));
            
            element.classList.add('active');

            if (type === 'color') document.getElementById('selectedColor').value = element.getAttribute('data-value');
            if (type === 'size') document.getElementById('selectedSize').value = element.getAttribute('data-value');

            updatePrice();
        }

        function updatePrice() {
            if (!hasVariants) return;

            const color = document.getElementById('selectedColor').value;
            const size = document.getElementById('selectedSize').value;
            const priceEl = document.getElementById('displayPrice');
            const stockEl = document.getElementById('stock-status');
            const btnCart = document.getElementById('btn-add-cart');
            const btnText = document.getElementById('btn-text');

            if (color && size) {
                const found = variantsData.find(v => v.color === color && v.size === size);

                if (found) {
                    priceEl.innerHTML = found.price.toLocaleString('vi-VN') + '₫';
                    
                    if (found.stock > 0) {
                        stockEl.innerHTML = `Kho: <span class="text-dark fw-bold">${found.stock}</span> sản phẩm`;
                        stockEl.classList.remove('text-danger');
                        btnCart.disabled = false;
                        btnText.innerText = 'Thêm vào giỏ';
                    } else {
                        stockEl.innerHTML = '<span class="text-danger">Hết hàng</span>';
                        btnCart.disabled = true;
                        btnText.innerText = 'Đã hết hàng';
                    }
                } else {
                    priceEl.innerText = '---';
                    stockEl.innerHTML = '<span class="text-danger">Phiên bản này không tồn tại</span>';
                    btnCart.disabled = true;
                    btnText.innerText = 'Không khả dụng';
                }
            }
        }
    </script>
</body>
</html>