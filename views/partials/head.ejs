<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <% 
        // 1. LOGIC SEO & THEME SETTINGS
        // Kiểm tra thứ ưu tiên: Bài viết -> Sản phẩm -> Trang tĩnh -> Mặc định
        let currentItem = (typeof post !== 'undefined') ? post : ((typeof product !== 'undefined') ? product : ((typeof page !== 'undefined') ? page : null));
        
        // Lấy dữ liệu theme từ res.locals (Middleware trong app.js)
        let siteTheme = (typeof theme !== 'undefined' && theme) ? theme : {};

        // Tiêu đề: Ưu tiên SEO Title -> Tên item -> Tiêu đề trang
        let finalTitle = (currentItem && currentItem.seoTitle) ? currentItem.seoTitle : pageTitle;
        
        // Mô tả: Ưu tiên SEO Description -> Tóm tắt bài viết -> Top Bar Text -> Mặc định
        let rawDesc = (currentItem && currentItem.seoDescription) ? currentItem.seoDescription : 
                      ((currentItem && currentItem.summary) ? currentItem.summary : 
                      (siteTheme.topBarText || "Chuyên cung cấp sản phẩm chất lượng cao."));
        // Loại bỏ HTML nếu có trong mô tả để tránh lỗi thẻ meta
        let finalDesc = rawDesc.replace(/<[^>]*>?/gm, '').substring(0, 160);

        // Ảnh: Ưu tiên Thumbnail -> Logo website -> Ảnh mặc định
        let finalImage = (currentItem && currentItem.thumbnail) ? currentItem.thumbnail : (siteTheme.logo || "/images/default-share.jpg");
        
        let domain = "https://webbanhang-es90.onrender.com"; 
    %>

    <title><%= finalTitle %></title>
    <meta name="description" content="<%= finalDesc %>">
    <link rel="canonical" href="<%= domain %><%= typeof path !== 'undefined' ? path : '' %>">

    <% if (siteTheme.favicon) { %>
        <link rel="icon" type="image/x-icon" href="<%= siteTheme.favicon %>">
    <% } else { %>
        <link rel="icon" type="image/png" href="/images/favicon.png">
    <% } %>

    <meta property="og:type" content="website">
    <meta property="og:url" content="<%= domain %><%= typeof path !== 'undefined' ? path : '' %>">
    <meta property="og:title" content="<%= finalTitle %>">
    <meta property="og:description" content="<%= finalDesc %>">
    <meta property="og:image" content="<%= finalImage %>">

    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="<%= finalTitle %>">
    <meta name="twitter:description" content="<%= finalDesc %>">
    <meta name="twitter:image" content="<%= finalImage %>">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>

    <% if (typeof globalScripts !== 'undefined' && globalScripts.headerScripts) { %>
        <%- globalScripts.headerScripts %>
    <% } %>

    <style>
        body { background-color: #f0f2f5; }
        .admin-wrapper { display: flex; }
        .admin-content { flex: 1; padding: 20px; min-height: 100vh; overflow-y: auto; }
        .nav-link:hover { background-color: #343a40; }
        .nav-link.active { background-color: #0d6efd !important; }
        .card { border: none; border-radius: 8px; }

        /* NHÚNG CUSTOM CSS TỪ ADMIN CUSTOMIZE */
        <% if (siteTheme.customCss) { %>
            <%- siteTheme.customCss %>
        <% } %>
    </style>