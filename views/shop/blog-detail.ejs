<%- include('../partials/head.ejs') %>
<style>
    .transition-img { transition: transform 0.5s ease; }
    .card:hover .transition-img { transform: scale(1.1); }
    .category-badge { position: absolute; top: 15px; left: 15px; z-index: 10; }
    .blog-header { background: #f8f9fa; border-bottom: 1px solid #eee; padding: 60px 0; }
    .category-desc { max-width: 800px; margin: 0 auto; line-height: 1.6; }
    /* Style mục lục chuẩn FixToc */
    .toc-container {
        background: #f9f9f9;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 25px;
        display: inline-block;
        min-width: 300px;
        max-width: 100%;
    }
    .toc-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
        border-bottom: 1px solid #eee;
        padding-bottom: 8px;
    }
    .toc-title {
        font-weight: 700;
        font-size: 16px;
        color: #2d3748;
        display: flex;
        align-items: center;
    }
    .toc-toggle {
        cursor: pointer;
        font-size: 13px;
        color: #4a5568;
        background: #edf2f7;
        padding: 2px 8px;
        border-radius: 4px;
        user-select: none;
    }
    .toc-list {
        list-style: none;
        padding: 0;
        margin: 0;
        transition: all 0.3s ease;
    }
    .toc-list li {
        margin: 8px 0;
        line-height: 1.4;
    }
    .toc-list a {
        text-decoration: none;
        color: #4a5568;
        font-size: 15px;
        transition: color 0.2s;
    }
    .toc-list a:hover { color: #2b6cb0; text-decoration: underline; }
    
    /* Thụt lề cho H3 */
    .toc-item-h3 { margin-left: 20px !important; font-size: 14px !important; }
    
    /* Hiệu ứng ẩn mục lục */
    .toc-list.collapsed { display: none; }
</style>
</head>
<body>
  <%- include('../partials/shop-header.ejs') %>

    <div class="container py-5">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="/" class="text-decoration-none text-dark">Trang chủ</a></li>
                        <li class="breadcrumb-item"><a href="/blog" class="text-decoration-none text-dark">Tin tức</a></li>
                        <li class="breadcrumb-item active" aria-current="page"><%= post.title %></li>
                    </ol>
                </nav>

                <article>
                    <h1 class="fw-bold mb-3"><%= post.title %></h1>
                    <div class="text-muted mb-4 d-flex align-items-center">
                        <span class="me-3"><i class="far fa-calendar"></i> <%= post.createdAt.toLocaleDateString('vi-VN') %></span>
                        <span class="me-3"><i class="far fa-folder"></i> <%= post.category ? post.category.name : 'Chung' %></span>
                        <span><i class="far fa-eye"></i> <%= post.views %> lượt xem</span>
                    </div>

                    <img src="<%= post.thumbnail %>" class="img-fluid rounded mb-4 w-100" alt="<%= post.title %>">

                    <div class="blog-content fs-5 lh-lg">
                       <div id="toc-placeholder"></div>
                        <div id="post-content" class="entry-content">
                            <%- post.content %>
                        </div>
                        </div>
                </article>

                <hr class="my-5">

                <% if(relatedPosts.length > 0) { %>
                    <h4 class="fw-bold mb-4">Bài viết liên quan</h4>
                    <div class="row g-3">
                        <% relatedPosts.forEach(rp => { %>
                            <div class="col-md-4">
                                <div class="card h-100 border-0">
                                    <a href="/blog/<%= rp.slug %>">
                                        <img src="<%= rp.thumbnail %>" class="card-img-top rounded" style="height: 150px; object-fit: cover;">
                                    </a>
                                    <div class="card-body px-0">
                                        <h6 class="card-title">
                                            <a href="/blog/<%= rp.slug %>" class="text-decoration-none text-dark">
                                                <%= rp.title %>
                                            </a>
                                        </h6>
                                    </div>
                                </div>
                            </div>
                        <% }) %>
                    </div>
                <% } %>
            </div>
        </div>
    </div>

    <%- include('../partials/footer.ejs') %>

    <script>
document.addEventListener("DOMContentLoaded", function() {
    const contentArea = document.getElementById('post-content');
    const tocPlaceholder = document.getElementById('toc-placeholder');
    
    if (!contentArea || !tocPlaceholder) return;

    // 1. Tìm tất cả các thẻ h2 và h3
    const headings = contentArea.querySelectorAll('h2, h3');
    
    if (headings.length < 2) return; // Nếu có ít hơn 2 heading thì không cần hiện mục lục

    // 2. Tạo khung Mục lục
    let tocHtml = `
        <div class="toc-container">
            <div class="toc-header">
                <div class="toc-title"><i class="fas fa-list-ul me-2"></i> Mục lục bài viết</div>
                <div class="toc-toggle" id="toc-toggle-btn">[Ẩn]</div>
            </div>
            <ul class="toc-list" id="toc-main-list">
    `;

    headings.forEach((heading, index) => {
        // Tạo ID cho heading nếu chưa có để làm anchor link
        const id = heading.id || `section-${index}`;
        heading.id = id;

        const level = heading.tagName.toLowerCase(); // h2 hoặc h3
        const text = heading.innerText;

        tocHtml += `
            <li class="toc-item-${level}">
                <a href="#${id}">${text}</a>
            </li>
        `;
    });

    tocHtml += `</ul></div>`;
    tocPlaceholder.innerHTML = tocHtml;

    // 3. Xử lý sự kiện Đóng/Mở (Collapse)
    const toggleBtn = document.getElementById('toc-toggle-btn');
    const tocList = document.getElementById('toc-main-list');

    toggleBtn.addEventListener('click', function() {
        if (tocList.classList.contains('collapsed')) {
            tocList.classList.remove('collapsed');
            toggleBtn.innerText = '[Ẩn]';
        } else {
            tocList.classList.add('collapsed');
            toggleBtn.innerText = '[Hiện]';
        }
    });
});
</script>
</body>
</html>